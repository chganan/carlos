var bibtexify = function(e) {
    var t = function(e) {
            return e = e.replace(/\\"\{a\}/g, "&auml;").replace(/\{\\aa\}/g, "&aring;").replace(/\\aa\{\}/g, "&aring;").replace(/\\"a/g, "&auml;").replace(/\\"\{o\}/g, "&ouml;").replace(/\\'e/g, "&eacute;").replace(/\\'\{e\}/g, "&eacute;").replace(/\\'a/g, "&aacute;").replace(/\\'A/g, "&Aacute;").replace(/\\"o/g, "&ouml;").replace(/\\ss\{\}/g, "&szlig;").replace(/\{/g, "").replace(/\}/g, "").replace(/\\&/g, "&").replace(/--/g, "&ndash;")
        },
        a = function(e) {
            return e = e.replace(/\\"\{a\}/g, "%C3%A4").replace(/\{\\aa\}/g, "%C3%A5").replace(/\\aa\{\}/g, "%C3%A5").replace(/\\"a/g, "%C3%A4").replace(/\\"\{o\}/g, "%C3%B6").replace(/\\'e/g, "%C3%A9").replace(/\\'\{e\}/g, "%C3%A9").replace(/\\'a/g, "%C3%A1").replace(/\\'A/g, "%C3%81").replace(/\\"o/g, "%C3%B6").replace(/\\ss\{\}/g, "%C3%9F").replace(/\{/g, "").replace(/\}/g, "").replace(/\\&/g, "%26").replace(/--/g, "%E2%80%93")
        },
        r = {
            entry2html: function(e, a) {
                var s = e.entryType.toLowerCase(); - 1 === array_keys(r).indexOf(s) && (s = "misc", e.entryType = s);
                var i = t(r[s](e));
                return i += r.links(e), i += r.bibtex(e), a.options.tweet && e.url && (i += r.tweet(e, a)), i.replace(/undefined[,.]?/g, '<span class="undefined">missing</span>')
            },
            authors2html: function(e) {
                for (var a = "", r = 0; r < e.length; r++) r > 0 && (a += ", "), a += e[r].last;
                return t(a)
            },
            links: function(e) {
                var t = "";
                return e.url && e.url.match(/.*\.pdf/) ? t += ' (<a title="PDF-version of this article" href="' + e.url + '">pdf</a>)' : e.url && (t += ' (<a title="This article online" href="' + e.url + '">link</a>)'), t
            },
            bibtex: function(t) {
                var a = "";
                return a += ' (<a title="This article as BibTeX" href="#" class="biblink">bib</a>)<div class="bibinfo hidden">', a += '<a href="#" class="bibclose" title="Close">x</a><pre>', a += "@" + t.entryType + "{" + t.cite + ",\n", e.each(t, function(e, t) {
                    if ("author" == e) {
                        a += "  author = { ";
                        for (var r = 0; r < t.length; r++) r > 0 && (a += " and "), a += t[r].last;
                        a += " },\n"
                    } else "entryType" != e && "cite" != e && (a += "  " + e + " = { " + t + " },\n")
                }), a += "}</pre></div>"
            },
            tweet: function(e, t) {
                var r = ' (<a title="Tweet this article" href="http://twitter.com/share?url=';
                r += e.url, r += "&via=" + t.options.tweet, r += "&text=";
                var s = function(e) {
                        var t = e.split(" ");
                        return t[t.length - 1]
                    },
                    i = e.author;
                return 1 == i.length ? r += a(s(i[0].last)) : 2 == i.length ? r += a(s(i[0].last) + "%26" + s(i[1].last)) : r += a(s(i[0].last) + " et al"), r += ": " + encodeURIComponent('"' + e.title + '"'), r += '" target="_blank">tweet</a>)'
            },
            inproceedings: function(e) {
                return this.authors2html(e.author) + " (" + e.year + "). " + e.title + ". In <em>" + e.booktitle + ", pp. " + e.pages + (e.address ? ", " + e.address : "") + ".</em>"
            },
            article: function(e) {
                return this.authors2html(e.author) + " (" + e.year + "). " + e.title + ". <em>" + e.journal + ", " + e.volume + (e.number ? "(" + e.number + ")" : "") + ", pp. " + e.pages + ". " + (e.address ? e.address + "." : "") + "</em>"
            },
            misc: function(e) {
                return this.authors2html(e.author) + " (" + e.year + "). " + e.title + ". " + (e.howpublished ? e.howpublished + ". " : "") + (e.note ? e.note + "." : "")
            },
            mastersthesis: function(e) {
                return this.authors2html(e.author) + " (" + e.year + "). " + e.title + ". " + e.type + ". " + e.organization + ", " + e.school + "."
            },
            techreport: function(e) {
                return this.authors2html(e.author) + " (" + e.year + "). " + e.title + ". " + e.institution + ". " + e.number + ". " + e.type + "."
            },
            book: function(e) {
                return this.authors2html(e.author) + " (" + e.year + ").  <em>" + e.title + "</em>, " + e.publisher + ", " + e.year + (e.issn ? ", ISBN: " + e.issn + "." : ".")
            },
            inbook: function(e) {
                return this.authors2html(e.author) + " (" + e.year + "). " + e.chapter + " in <em>" + e.title + "</em>, " + (e.editor ? " Edited by " + e.editor + ", " : "") + e.publisher + ", pp. " + e.pages + (e.series ? ", <em>" + e.series + "</em>" : "") + (e.volume ? ", Vol. " + e.volume : "") + (e.issn ? ", ISBN: " + e.issn : "") + "."
            },
            importance: {
                TITLE: 9999,
                misc: 0,
                manual: 10,
                techreport: 20,
                mastersthesis: 30,
                inproceedings: 40,
                incollection: 50,
                proceedings: 60,
                conference: 70,
                article: 80,
                phdthesis: 90,
                inbook: 100,
                book: 110,
                unpublished: 120
            },
            labels: {
                article: "Journal",
                book: "Book",
                conference: "Workshop",
                inbook: "Book chapter",
                incollection: "",
                inproceedings: "Conference",
                manual: "Manual",
                mastersthesis: "Thesis",
                misc: "Misc",
                phdthesis: "PhD Thesis",
                proceedings: "Conference proceeding",
                techreport: "Technical report",
                unpublished: "Unpublished"
            }
        };
    r.phdthesis = r.mastersthesis, r.conference = r.inproceedings;
    var s = {
            showbib: function(t) {
                e(this).next(".bibinfo").removeClass("hidden").addClass("open"), e("#shutter").show(), t.preventDefault()
            },
            hidebib: function(t) {
                e("#shutter").hide(), e(".bibinfo.open").removeClass("open").addClass("hidden"), t.preventDefault()
            }
        },
        i = function(e, t, a) {
            this.options = a, this.$pubTable = t, this.stats = {}, this.initialize(e)
        },
        n = i.prototype;
    return n.initialize = function(t) {
            var a = new BibTex;
            a.content = t, a.parse();
            var i = [],
                n = a.data.length,
                o = {};
            jQuery.extend(!0, r, this.options.bib2html);
            for (var l = 0; l < n; l++) {
                var c = a.data[l];
                c.year || (c.year = this.options.defaultYear || "To Appear");
                var h = r.entry2html(c, this);
                i.push([c.year, r.labels[c.entryType], h]), o[r.labels[c.entryType]] = c.entryType, this.updateStats(c)
            }
            jQuery.fn.dataTableExt.oSort["type-sort-asc"] = function(e, t) {
                var a = r.importance[o[e]],
                    s = r.importance[o[t]];
                return a < s ? -1 : a > s ? 1 : 0
            }, jQuery.fn.dataTableExt.oSort["type-sort-desc"] = function(e, t) {
                var a = r.importance[o[e]],
                    s = r.importance[o[t]];
                return a < s ? 1 : a > s ? -1 : 0
            };
            var u = this.$pubTable.dataTable(e.extend({}, {
                aaData: i,
                aaSorting: this.options.sorting,
                aoColumns: [{
                    sTitle: "Year"
                }, {
                    sTitle: "Type",
                    sType: "type-sort",
                    asSorting: ["desc", "asc"]
                }, {
                    sTitle: "Publication",
                    bSortable: !1
                }],
                bPaginate: !1
            }, this.options));
            this.options.visualization && this.addBarChart(), e("th", this.$pubTable).unbind("click").click(function(t) {
                var a = e(this),
                    r = a.parent().find("th"),
                    s = r.index(a);
                a.hasClass("sorting_disabled") || (a.toggleClass("sorting_asc").toggleClass("sorting_desc"), 0 === s ? u.fnSort([
                    [0, r.eq(0).hasClass("sorting_asc") ? "asc" : "desc"],
                    [1, r.eq(1).hasClass("sorting_asc") ? "asc" : "desc"]
                ]) : u.fnSort([
                    [1, r.eq(1).hasClass("sorting_asc") ? "asc" : "desc"],
                    [0, r.eq(0).hasClass("sorting_asc") ? "asc" : "desc"]
                ]))
            }), e(".biblink", this.$pubTable).on("click", s.showbib), e(".bibclose", this.$pubTable).on("click", s.hidebib)
        }, n.updateStats = function(e) {
            this.stats[e.year] ? (this.stats[e.year].count += 1, this.stats[e.year].types[e.entryType] ? this.stats[e.year].types[e.entryType] += 1 : this.stats[e.year].types[e.entryType] = 1) : (this.stats[e.year] = {
                count: 1,
                types: {}
            }, this.stats[e.year].types[e.entryType] = 1)
        }, n.addBarChart = function() {
            var t = [],
                a = 0;
            e.each(this.stats, function(e, r) {
                a = Math.max(a, r.count), t.push({
                    year: e,
                    count: r.count,
                    item: r,
                    types: r.types
                })
            }), t.sort(function(e, t) {
                var a = e.year - t.year;
                return isNaN(a) ? e.year < t.year ? -1 : e.year > t.year ? 1 : 0 : a
            });
            var s = "#" + this.$pubTable[0].id + "pubchart",
                i = e(s).height() / a - 2,
                n = [],
                o = function(t) {
                    var s = [],
                        o = '<div class="year">',
                        l = 0;
                    e.each(t.types, function(e, t) {
                        s.push(e), l += t
                    }), s.sort(function(e, t) {
                        return r.importance[t] - r.importance[e]
                    }), o += '<div class="filler" style="height:' + i * (a - l) + 'px;"></div>';
                    for (var c = 0; c < s.length; c++) {
                        var h = s[c]; - 1 === n.indexOf(h) && n.push(h);
                        for (var u = 0; u < t.types[h]; u++) o += '<div class="pub ' + h + '"></div>'
                    }
                    return o + '<div class="yearlabel">' + t.year + "</div></div>"
                },
                l = "<style>" + (s + " .year { width: " + 100 / t.length + "%; }" + s + " .pub { height: " + i + "px; }") + "</style>";
            t.forEach(function(e) {
                l += o(e)
            });
            for (var c = '<div class="legend">', h = 0, u = n.length; h < u; h++) {
                var p = n[h];
                c += '<span class="pub ' + p + '"></span>' + r.labels[p]
            }
            c += "</div>", e(s).html(l).after(c)
        },
        function(t, a, r) {
            var n = e.extend({}, {
                    visualization: !0,
                    sorting: [
                        [0, "desc"],
                        [1, "desc"]
                    ]
                }, r),
                o = e("#" + a).addClass("bibtable");
            0 === e("#shutter").size() && (o.before('<div id="shutter" class="hidden"></div>'), e("#shutter").click(s.hidebib)), n.visualization && o.before('<div id="' + a + 'pubchart" class="bibchart"></div>');
            var l;
            if (-1 === t.indexOf("/") && (l = e(t)), l && l.length) new i(l.html(), o, n), l.hide();
            else {
                var c = function(e) {
                    new i(e, o, n)
                };
                e.get(t, c, "text")
            }
        }
}(jQuery);